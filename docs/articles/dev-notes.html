<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Developer Notes • lexl</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script><script src="../pkgdown.js"></script><!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-vignette">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../index.html">lexl</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="..//index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/dev-notes.html">Developer Notes</a>
    </li>
    <li>
      <a href="../articles/lex-xl.html">Tokenise Excel Formulas</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9">
    <div class="page-header toc-ignore">
      <h1>Developer Notes</h1>
            
            <h4 class="date">2017-09-26</h4>
          </div>

    
    
<div class="contents">
<div id="what-does-it-do" class="section level2">
<h2 class="hasAnchor">
<a href="#what-does-it-do" class="anchor"></a>What does it do?</h2>
<p><code>lexl</code> tokenises Excel formulas into some kind of parse tree, represented by a data frame with three columns: the tokens themselves, the type, and the level within the nested structure.</p>
</div>
<div id="how-does-tokenise-formulas" class="section level2">
<h2 class="hasAnchor">
<a href="#how-does-tokenise-formulas" class="anchor"></a>How does tokenise formulas?</h2>
<p>The bulk of the work is done by a parser generator, according to a grammer defined in <code>src/token_grammar.h</code>.</p>
<div id="what-is-a-parser-generator" class="section level3">
<h3 class="hasAnchor">
<a href="#what-is-a-parser-generator" class="anchor"></a>What is a parser generator?</h3>
<p>A parser generator is a kind of supercharged REGEX engine, which allows actions to be carried out upon each successful match of a particular group within the overall pattern. I don’t know much about parser generators, so the rest of this</p>
<p>For example, in REGEX you might define a group by enclosing it within parentheses, so that <code>Na(na)* Batman</code> would match <code>Nanana Batman</code> as well as <code>Nananananananana Batman</code>. With a parser generator, the pattern between the parentheses is called a ‘rule’, and there is nothing that isn’t a rule – even string literals must be set up as rules.</p>
<p>Any action defined for a given rule/group/pattern/what-you-will is carried out whenever the rule is successfully matched. For example, you could define an action that prints <code>"Hey Jude?"</code>, to be carried out when the rule <code>(na)</code> is matched. Given the Batman string above, it that action would be performed several times.</p>
<p>Rules can be disabled, and there are some tricks you can pull to have them act differently depending on the current state, but really they’re pretty inflexible. The most annoying problem is backtracking.</p>
</div>
<div id="backtracking" class="section level3">
<h3 class="hasAnchor">
<a href="#backtracking" class="anchor"></a>Backtracking</h3>
<p>This can happen when a rule is composed of subrules. The parser attempts to match the whole rule, and does not fail until it has already matched some of the subrules. The parser will ‘wind the tape back’ (go back to the place in the string where it started to match the overall rule), but any actions defined on the subrules will already have been performed.</p>
<p>For example, if the overall rule is <code>Na(na)* Batman</code>, and the string to be matched is <code>Nananananananana Robin</code>, then <code>"Hey Jude?"</code> would still be printed several times before the overall rule failed to match.</p>
<p><code>lex_xl</code> avoids this problem by disabling certain rules. The trade-off is that it the resulting parse tree isn’t very detailed. If it needs to become more detailed, then I must either become wickedly clever, or re-implement the grammer using <code>boost::spirit</code> (which can do something about backtracking, albeit slow), or parse the affected tokens a second time, using another grammer.</p>
</div>
</div>
<div id="todo" class="section level2">
<h2 class="hasAnchor">
<a href="#todo" class="anchor"></a>TODO</h2>
<div id="pretty-print-abstract-syntax-tree-in-console" class="section level3">
<h3 class="hasAnchor">
<a href="#pretty-print-abstract-syntax-tree-in-console" class="anchor"></a>Pretty print abstract syntax tree in console</h3>
<p>A minimum thing would be like:</p>
<pre><code>print(lex_xl("MIN(3,MAX(2,A1))"))
\- root
 \- MIN
 \- (
  \- 3
  \- ,
  \- MAX
  \- (
   \- 2
   \- ,
   \- A1
  \- )
 \- )</code></pre>
<p>Or without the parentheses</p>
<pre><code>print(lex_xl("MIN(3,MAX(2,A1))"))
\- root
 \- MIN
  \- 3
  \- ,
  \- MAX
   \- 2
   \- ,
   \- A1</code></pre>
<p>Or in pseudo-<code>plyr::ast()</code> <a href="http://adv-r.had.co.nz/Expressions.html">style</a> (via Jenny Bryan), thinking of something clever for operators. Excel doesn’t have inline function definitions, and function arguments are positional, not named, so pairlists can be ignored.</p>
<pre><code>print(lex_xl("MIN(3,MAX(2,A1))"))
\- root
 \- ()
  \- `MIN
  \- 3
  \- ()
   \- `MAX
   \- 2
   \- `A1</code></pre>
<p>Operators would have to be handled using associativity. Fortunately, Excel operators are consistently left-associative (so in Excel <code>2^2^3</code> is 64, whereas in R and most other languages it is 256), which makes the logic easier.</p>
<div id="api" class="section level4">
<h4 class="hasAnchor">
<a href="#api" class="anchor"></a>API</h4>
<ul>
<li>As an S3 override of <code>plot()</code>?</li>
<li>As a separate function <code>lex_tree()</code>?</li>
</ul>
<p>I think it’s important that users realise it’s just a data frame. How does data.tree do it?</p>
</div>
</div>
<div id="evaluate-formulas" class="section level3">
<h3 class="hasAnchor">
<a href="#evaluate-formulas" class="anchor"></a>Evaluate formulas</h3>
<p>This might well be possible using <code>shiny</code>. Joe Cheng kindly wrote me an demo of general reactivity.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(shiny)

a &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/shiny/topics/reactiveVal">reactiveVal</a></span>(<span class="dv">0</span>)
b &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/shiny/topics/reactive">reactive</a></span>(<span class="op">-</span><span class="kw"><a href="http://www.rdocumentation.org/packages/shiny/topics/builder">a</a></span>())
c &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/shiny/topics/observe">observe</a></span>(<span class="kw">print</span>(<span class="kw">b</span>()))

shiny<span class="op">:::</span><span class="kw">flushReact</span>()


workbook &lt;-<span class="st"> </span><span class="kw">new.env</span>()

<span class="co"># For each formula cell</span>
workbook[[cell_id]] &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/shiny/topics/reactive">reactive</a></span>({
  <span class="co"># formula</span>
  workbook[[<span class="st">"other_cell"</span>]]()
})

<span class="co"># For each value cell</span>
workbook[[cell_id]] &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/shiny/topics/reactiveVal">reactiveVal</a></span>(initialValue)</code></pre></div>
<p>References to external files (<code>[0]Sheet1!A1</code>) would have to be resolved to find their value. Fortunately these values are written into the local file.</p>
</div>
<div id="test-shiny" class="section level3">
<h3 class="hasAnchor">
<a href="#test-shiny" class="anchor"></a>Test Shiny</h3>
<p>Use <a href="https://rstudio.github.io/shinytest/articles/shinytest.html">shinytest</a></p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#what-does-it-do">What does it do?</a></li>
      <li><a href="#how-does-tokenise-formulas">How does tokenise formulas?</a></li>
      <li><a href="#todo">TODO</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Duncan Garmonsway.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://hadley.github.io/pkgdown/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  </body>
</html>
